{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "ScubaGear Configuration Schema",
  "description": "JSON Schema for ScubaGear configuration validation",
  "type": "object",
  "properties": {
    "ProductNames": {
      "type": "array",
      "description": "List of products to assess",
      "items": {
        "type": "string",
        "enum": ["aad", "defender", "exo", "powerplatform", "sharepoint", "teams", "*"]
      },
      "minItems": 1,
      "uniqueItems": true
    },
    "M365Environment": {
      "type": "string",
      "description": "Microsoft 365 environment type",
      "enum": ["commercial", "gcc", "gcchigh", "dod"],
      "default": "commercial"
    },
    "OPAPath": {
      "$ref": "#/definitions/patterns/filePath",
      "description": "Path to OPA executable directory",
      "testPath": true
    },
    "LogIn": {
      "$ref": "#/definitions/types/booleanWithTrueDefault",
      "description": "Whether to perform login during execution"
    },
    "DisconnectOnExit": {
      "$ref": "#/definitions/types/booleanWithFalseDefault",
      "description": "Whether to disconnect from services on exit"
    },
    "OutPath": {
      "type": "string",
      "description": "Output directory path",
      "testPath": true
    },
    "OutFolderName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "Output folder name"
    },
    "OutProviderFileName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "Provider settings export filename"
    },
    "OutRegoFileName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "Rego test results filename"
    },
    "OutReportName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "HTML report filename"
    },
    "OutJsonFileName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "JSON results filename"
    },
    "OutCsvFileName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "CSV results filename"
    },
    "OutActionPlanFileName": {
      "$ref": "#/definitions/patterns/filename",
      "description": "Action plan filename"
    },
    "NumberOfUUIDCharactersToTruncate": {
      "type": "integer",
      "description": "Number of UUID characters to truncate in output",
      "minimum": 0,
      "maximum": 36,
      "default": 18
    },
    "Organization": {
      "$ref": "#/definitions/patterns/orgDomain",
      "description": "Organization domain name (Fully Qualified Domain Name)"
    },
    "OrgName": {
      "type": "string",
      "description": "Organization display name",
      "minLength": 1,
      "maxLength": 100
    },
    "OrgUnitName": {
      "type": "string",
      "description": "Organizational unit name",
      "minLength": 1,
      "maxLength": 100
    },
    "Description": {
      "type": "string",
      "description": "Configuration description",
      "maxLength": 500
    },
    "AppId": {
      "$ref": "#/definitions/patterns/appGuid",
      "description": "Entra ID Application ID for service principal authentication"
    },
    "CertificateThumbprint": {
      "$ref": "#/definitions/patterns/thumbprint",
      "description": "Certificate thumbprint for service principal authentication"
    },
    "PreferredDnsResolvers": {
      "type": "array",
      "description": "Preferred DNS resolver IP addresses",
      "items": {
        "$ref": "#/definitions/patterns/ipv4"
      }
    },
    "SkipDoH": {
      "$ref": "#/definitions/types/booleanWithFalseDefault",
      "description": "Skip DNS over HTTPS for DNS queries"
    },
    "Aad": {
      "$ref": "#/definitions/AadExclusions",
      "description": "Azure Entra ID exclusions configuration"
    },
    "Defender": {
      "$ref": "#/definitions/DefenderExclusions",
      "description": "Microsoft Defender exclusions configuration"
    },
    "Exo": {
      "$ref": "#/definitions/ExoExclusions",
      "description": "Exchange Online exclusions configuration"
    },
    "PowerPlatform": {
      "$ref": "#/definitions/PowerPlatformExclusions",
      "description": "Power Platform exclusions configuration"
    },
    "SharePoint": {
      "$ref": "#/definitions/SharePointExclusions",
      "description": "SharePoint exclusions configuration"
    },
    "Teams": {
      "$ref": "#/definitions/TeamsExclusions",
      "description": "Teams exclusions configuration"
    },
    "OmitPolicy": {
      "type": "object",
      "description": "Policies to omit from assessment",
      "patternProperties": {
        "^[Mm][Ss]\\.[a-zA-Z]+\\.[0-9]+\\.[0-9]+[Vv][0-9]+$": {
          "oneOf": [
            {
              "type": "string",
              "description": "Justification for omitting the policy"
            },
            {
              "type": "object",
              "properties": {
                "Rationale": {
                  "type": "string",
                  "description": "Justification for omitting the policy"
                }
              },
              "required": ["Rationale"],
              "additionalProperties": false
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "AnnotatePolicy": {
      "type": "object",
      "description": "Policy annotations",
      "patternProperties": {
        "^[Mm][Ss]\\.[a-zA-Z]+\\.[0-9]+\\.[0-9]+[Vv][0-9]+$": {
          "oneOf": [
            {
              "type": "string",
              "description": "Annotation text for the policy"
            },
            {
              "type": "object",
              "properties": {
                "Comment": {
                  "type": "string",
                  "description": "Annotation text for the policy"
                }
              },
              "required": ["Comment"],
              "additionalProperties": false
            }
          ]
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": true,
  "definitions": {
    "types": {
      "booleanWithTrueDefault": {
        "type": "boolean",
        "default": true
      },
      "booleanWithFalseDefault": {
        "type": "boolean",
        "default": false
      }
    },
    "patterns": {
      "guid": {
        "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$",
        "friendlyName": "GUID format"
      },
      "fqdn": {
        "pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
        "friendlyName": "displayname@fqdn format"
      },
      "appGuid": {
        "type": "string",
        "pattern": "^[{(]?[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}[)}]?$",
        "friendlyName": "application GUID format"
      },
      "thumbprint": {
        "type": "string",
        "pattern": "^[A-Fa-f0-9]{40}$",
        "friendlyName": "certificate thumbprint (40 hex chars)"
      },
      "ipv4": {
        "type": "string",
        "pattern": "^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$",
        "friendlyName": "IPv4 address format"
      },
      "filename": {
        "type": "string",
        "pattern": "^[a-zA-Z0-9._-]+$",
        "friendlyName": "filename without extensions"
      },
      "filePath": {
        "type": "string",
        "pattern": "^([a-zA-Z]:[\\\\/].*|[\\\\/]{2}[^\\\\/]+[\\\\/].*|\\.|\\.\\\\/.*|\\.\\\\\\..*|\\.[\\\\/].*|[^\\.:][^\\\\/]*[\\\\/]?.*)$",
        "friendlyName": "file path (absolute, UNC, or relative)"
      },
      "sensitiveUser": {
        "pattern": "^.+;[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
        "friendlyName": "DisplayName;EmailAddress format"
      },
      "orgDomain": {
        "type": "string",
        "pattern": "^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]\\.[a-zA-Z]{2,}$|^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9](\\.[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9])+\\.[a-zA-Z]{2,}$",
        "friendlyName": "domain name (FQDN)"
      }
    },
    "AadExclusions": {
      "type": "object",
      "properties": {
        "CapExclusions": {
          "type": "object",
          "properties": {
            "Users": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
              },
              "description": "User object IDs (GUIDs) to exclude from CAP evaluation"
            },
            "Groups": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
              },
              "description": "Group object IDs (GUIDs) to exclude from CAP evaluation"
            }
          }
        },
        "RoleExclusions": {
          "type": "object",
          "properties": {
            "Users": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
              },
              "description": "User object IDs (GUIDs) to exclude from role requirements"
            },
            "Groups": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$"
              },
              "description": "Group object IDs (GUIDs) to exclude from role requirements"
            }
          }
        }
      }
    },
    "DefenderExclusions": {
      "type": "object",
      "properties": {
        "SensitiveAccounts": {
          "type": "object",
          "properties": {
            "IncludedUsers": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
              },
              "description": "User Principal Names (UPNs) to include in sensitive accounts"
            },
            "IncludedGroups": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
              },
              "description": "Group Principal Names (fully qualified domain names) to include in sensitive accounts"
            },
            "IncludedDomains": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Domains to include in sensitive accounts"
            },
            "ExcludedUsers": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
              },
              "description": "User Principal Names (UPNs) to exclude from sensitive accounts"
            },
            "ExcludedGroups": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
              },
              "description": "Group Principal Names (fully qualified domain names) to exclude from sensitive accounts"
            },
            "ExcludedDomains": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Domains to exclude from sensitive accounts"
            }
          }
        },
        "SensitiveUsers": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^.+;[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
            "description": "Sensitive user in format 'DisplayName;EmailAddress'"
          },
          "description": "List of sensitive users with display name and email separated by semicolon"
        }
      }
    },
    "ExoExclusions": {
      "type": "object",
      "properties": {
        "AllowedForwardingDomains": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Domains allowed for automatic email forwarding"
        },
        "PartnerDomains": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Partner domain names"
        },
        "AgencyDomains": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Agency domain names"
        }
      }
    },
    "PowerPlatformExclusions": {
      "type": "object",
      "properties": {},
      "description": "Power Platform exclusions (structure to be defined)"
    },
    "SharePointExclusions": {
      "type": "object",
      "properties": {},
      "description": "SharePoint exclusions (structure to be defined)"
    },
    "TeamsExclusions": {
      "type": "object",
      "properties": {},
      "description": "Teams exclusions (structure to be defined)"
    }
  }
}
